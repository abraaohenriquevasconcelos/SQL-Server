CREATE DATABASE [teste6]
ON  PRIMARY 
( NAME = N'teste6', FILENAME = N'D:\DATA\teste6.mdf' , SIZE = 8192KB , FILEGROWTH = 65536KB )
LOG ON 
( NAME = N'teste6_log', FILENAME = N'D:\LOG\teste6_log.ldf' , SIZE = 8192KB , FILEGROWTH = 65536KB )
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
GO
USE teste6
GO
CREATE TABLE tabela1 (num INT NOT NULL)
GO
INSERT INTO tabela1 VALUES (01)
GO
INSERT INTO tabela1 VALUES (02)
GO
INSERT INTO tabela1 VALUES (03)
GO
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
BACKUP DATABASE [teste6] 
TO  DISK = N'D:\BACKUP\FULL\teste6_10122017.bak' 
WITH 
NOFORMAT, NOINIT,  
NAME = N'teste6-Full Database Backup', 
SKIP, NOREWIND, NOUNLOAD,  STATS = 5, 
Compression

GO
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
CREATE DATABASE [teste7]
ON  PRIMARY 
( NAME = N'teste7', FILENAME = N'D:\DATA\teste7.mdf' , SIZE = 8192KB , FILEGROWTH = 65536KB )
LOG ON 
( NAME = N'teste7_log', FILENAME = N'D:\LOG\teste7_log.ldf' , SIZE = 8192KB , FILEGROWTH = 65536KB )
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
CREATE TABLE pessoa(nome VARCHAR(50))
INSERT INTO pessoa VALUES('ABRAAO')
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
USE [master]
GO
CREATE LOGIN [login_3] WITH PASSWORD=N'123', DEFAULT_DATABASE=[master], CHECK_EXPIRATION=OFF, CHECK_POLICY=OFF
GO

USE [master]
GO
CREATE LOGIN [login_4] WITH PASSWORD=N'123', DEFAULT_DATABASE=[master], CHECK_EXPIRATION=OFF, CHECK_POLICY=OFF
GO

------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
USE [teste7]
GO
CREATE USER [teste7_user1] FOR LOGIN [login_3]
GO
USE [teste7]
GO
ALTER ROLE [db_datareader] ADD MEMBER [teste7_user1]
GO

USE [teste7]
GO
CREATE USER [teste7_user2] FOR LOGIN [login_4]
GO
USE [teste7]
GO
ALTER ROLE [db_datareader] ADD MEMBER [teste7_user2]
GO

------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

CREATE LOGIN [login_5] WITH PASSWORD=N'123', DEFAULT_DATABASE=[master], CHECK_EXPIRATION=OFF, CHECK_POLICY=OFF
GO
USE [teste7]
GO
CREATE USER [login_5] FOR LOGIN [login_5]
GO
USE [teste7]
GO
ALTER ROLE [db_datareader] ADD MEMBER [login_5]
GO
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

select  DP2.name,L.loginname
from  sys.database_role_members DRM inner join 
sys.database_principals DP on DRM.role_principal_id = DP.principal_id inner join sys.database_principals DP2 on DRM.member_principal_id = DP2.principal_id 
inner join sys.syslogins L ON DP2.name = L.loginname COLLATE SQL_Latin1_General_CP1_CI_AI  WHERE L.sysadmin <> 1 


SELECT * FROM sys.database_role_members -- role_principal_id, member_principal_id
SELECT * FROM sys.database_principals -- name, principal_id, type
SELECT* FROM sys.syslogins
USE teste7
GO
SELECT name, create_date FROM sys.database_principals WHERE type_desc = 'SQL_USER'
GO

select  DP2.name,L.loginname
from  sys.database_role_members DRM inner join 
sys.database_principals DP on DRM.role_principal_id = DP.principal_id inner join sys.database_principals DP2 on DRM.member_principal_id = DP2.principal_id 
inner join sys.syslogins L ON DP2.name <> L.loginname COLLATE SQL_Latin1_General_CP1_CI_AI  WHERE L.sysadmin <> 1 

------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

CREATE LOGIN [login_8] WITH PASSWORD=N'123', DEFAULT_DATABASE=[master], CHECK_EXPIRATION=OFF, CHECK_POLICY=OFF
GO
USE [teste7]
GO
CREATE USER [login_8] FOR LOGIN [login_8]
GO
USE [teste7]
GO
ALTER ROLE [db_datareader] ADD MEMBER [login_8]
GO

------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
RESTORE FILELISTONLY FROM DISK ='D:\BACKUP\FULL\teste6_10122017.bak'

--De
teste6			D:\DATA\teste6.mdf
teste6_log      D:\LOG\teste6_log.ldf

--Para
teste7			D:\DATA\teste7.mdf
teste7_log		D:\LOG\teste7_log.ldf

SELECT * FROM sys.sysprocesses WHERE dbid = DB_ID('teste7')
--SELECT DB_ID('teste7')
ALTER DATABASE teste7 SET SINGLE_USER WITH ROLLBACK IMMEDIATE;

USE [master]
RESTORE DATABASE [teste7] 
--FILE=N'teste3', 
--FILE=N'teste3_log'
FROM  DISK = N'D:\BACKUP\FULL\teste6_10122017.bak' 
WITH  
FILE = 1,  
MOVE N'teste6' TO N'D:\DATA\teste7.mdf', 
MOVE N'teste6_log' TO N'D:\LOG\teste7_log.ldf',  
NOUNLOAD, REPLACE, 
STATS = 5

------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

use teste7  IF(select user_id('login_5')) IS NULL BEGIN  CREATE USER [login_5] FOR LOGIN [login_5] END ELSE BEGIN EXEC sp_change_users_login 'update_one' , 'login_5' , 'login_5' END 
GO  
sp_addrolemember 'db_datareader','login_5'  
GO 
use teste7  IF(select user_id('login_8')) IS NULL BEGIN  CREATE USER [login_8] FOR LOGIN [login_8] END ELSE BEGIN EXEC sp_change_users_login 'update_one' , 'login_8' , 'login_8' END 
GO  
sp_addrolemember 'db_datareader','login_8'  
GO 
